---
import BaseLayout from "@/layouts/BaseLayout.astro";
import PageTitle from "@/components/PageTitle.astro";
import TextTitle from "@/components/TextTitle.astro"
import ReservationList from "@/components/ReservationList.astro";
import { getCalendarCells } from "@/lib/calendar";
import { client } from "@/lib/microcms";
import ScheduleText from "@/components/ScheduleText.astro";

// ä»Šæ—¥
const now = new Date();
const baseYear = now.getFullYear();
const baseMonth = now.getMonth(); // 0=1æœˆ

// microCMS ã‹ã‚‰äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—
const { contents } = await client.get({ endpoint: "reservation" });

// "YYYY-MM-DD" â†’ status ã®ãƒãƒƒãƒ—
const reservations: Record<string, string> = Object.fromEntries(
  contents.map((item: any) => [item.date, item.status])
);

// ä½•ãƒ¶æœˆåˆ†è¡¨ç¤ºã™ã‚‹ã‹ï¼ˆä¾‹ï¼šä»Šæœˆå«ã‚ã¦6ãƒ¶æœˆï¼‰
const MONTH_COUNT = 24;

// ä»Šæœˆã‹ã‚‰å…ˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’ã¾ã¨ã‚ã¦ä½œã‚‹
type CalendarInfo = {
  year: number;
  month: number; // 0-11
  label: string;
  items: { date: string; isOtherMonth: boolean }[];
};

const calendars: CalendarInfo[] = [];

for (let i = 0; i < MONTH_COUNT; i++) {
  const d = new Date(baseYear, baseMonth + i, 1);
  const year = d.getFullYear();
  const month = d.getMonth(); // 0-11
  const label = `${year}å¹´${month + 1}æœˆ`;

  const items = getCalendarCells(year, month);

  calendars.push({ year, month, label, items });
}
---

<BaseLayout title="äºˆç´„çŠ¶æ³ï½œãƒšãƒƒãƒˆãƒ›ãƒ†ãƒ«çŠ¬å¯" description="ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã¯ã€å®¿æ³Šã€ãŠé ã‹ã‚Šã€ä¸€æ™‚ãŠé ã‹ã‚Šã€ãŠæ•£æ­©ã€ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ã€ãŠæ‰‹å…¥ã‚Œ(çˆªåˆ‡ã‚Šã€è‚›é–€è…ºçµã‚Šã€è¶³è£ãƒãƒªã‚«ãƒ³ã€è€³æƒé™¤ã€è‚‰çƒã‚±ã‚¢ã€ãƒãƒƒã‚µãƒ¼ã‚¸)ã€ãªã©æ§˜ã€…ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’å–ã‚Šæƒãˆã¦ãŠã‚Šã¾ã™ã®ã§ã€å¾¡ä¸æ˜ç‚¹ã‚„æ°—ã«ãªã‚‹ç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚">
  <div id="schedule__pages">
    <div class="container">
      <PageTitle
        title="å¾¡äºˆç´„ã«ã¤ã„ã¦"
      />
      <p class="price-page__txt">
        å„ã‚µãƒ¼ãƒ“ã‚¹ã¯äºˆç´„åˆ¶ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚ãŠé›»è©±ã§ã®å—ä»˜æ™‚é–“ã¯6:00ã€œ21:00ã¾ã§ã€LINEã§ã®å—ä»˜ã¯24æ™‚é–“ã«ãªã‚Šã¾ã™ã€‚<br class="pc__only">
        æ™‚é–“å¸¯ã«ã‚ˆã£ã¦ã¯å¸Œæœ›ã®æ™‚é–“å¸¯ãŒåŸ‹ã¾ã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã®ã§ã€æ—©ã‚ã«å¾¡äºˆç´„ã‚’ãŠé¡˜ã„è‡´ã—ã¾ã™ã€‚<br class="pc__only">
        å¾¡äºˆç´„ã®å¾¡é€£çµ¡ãŒçŠ¶æ³ã«ã‚ˆã£ã¦ã¯å‡ºã‚‰ã‚Œãªã„å ´åˆã‚‚ã‚ã‚Šã¾ã™ãŒã€å¿…ãšæŠ˜ã‚Šè¿”ã—å¾¡é€£çµ¡ã‚’ã•ã›ã¦é ‚ãã¾ã™ã€‚<br class="pc__only">
        å½“ãƒ›ãƒ†ãƒ«ã§ã¯äº‹å‰ã«å¾¡äºˆç´„ãŒç„¡ã„æ—¥ã‚’åº—èˆ—ã®ä¼‘æ—¥ã¨ã•ã›ã¦é ‚ãã¾ã™ã®ã§ã€å½“æ—¥äºˆç´„ã®å ´åˆãŠå—ã‘ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã®ã§å¾¡æ³¨æ„ä¸‹ã•ã„ã€‚<br class="pc__only">
        ãŠé ã‹ã‚Šæ™‚é–“ã«ã¯ã€ãŠä¼šè¨ˆã‚„ã€å½“ãƒ›ãƒ†ãƒ«ã®ã‚·ã‚¹ãƒ†ãƒ èª¬æ˜ã€å¥‘ç´„ãªã©ã®æ™‚é–“ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚
      </p>
      <TextTitle
        title="äºˆç´„çŠ¶æ³"
      />
      <div class="schedule__inner">
        <div class="reservation-nav">
          <button
            type="button"
            class="nav-btn nav-btn--prev"
            data-cal-prev
          >
            å‰ã®æœˆ
          </button>
          <div class="month-picker">
            <span class="month-picker__label">è¡¨ç¤ºæœˆã‚’é¸æŠ</span>
            <select class="month-picker__select" data-cal-select>
              {calendars.map((cal, index) => (
                <option value={index}>
                  {cal.label}
                </option>
              ))}
            </select>
          </div>
          <button
            type="button"
            class="nav-btn nav-btn--next"
            data-cal-next
          >
            æ¬¡ã®æœˆ
          </button>
        </div>
        <div class="reservation-months">
          {calendars.map((cal, index) => (
            <section
              class={`reservation-month ${index === 0 ? "is-active" : ""}`}
              data-cal-index={index}
              aria-hidden={index === 0 ? "false" : "true"}
            >
              <ReservationList
                title={cal.label}
                items={cal.items}
                reservations={reservations}
              />
            </section>
          ))}
        </div>
        <ScheduleText />
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const monthEls = Array.from(
        document.querySelectorAll("[data-cal-index]")
      );
      const prevBtn = document.querySelector("[data-cal-prev]");
      const nextBtn = document.querySelector("[data-cal-next]");
      const selectEl = document.querySelector("[data-cal-select]");

      if (!monthEls.length || !prevBtn || !nextBtn || !selectEl) return;

      let currentIndex = 0;
      const maxIndex = monthEls.length - 1;

      const updateView = () => {
        monthEls.forEach((el, i) => {
          const isActive = i === currentIndex;
          el.classList.toggle("is-active", isActive);
          el.setAttribute("aria-hidden", isActive ? "false" : "true");
        });

        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
        prevBtn.disabled = currentIndex === 0;        // â† éå»ã®æœˆã«ã¯æˆ»ã‚Œãªã„
        nextBtn.disabled = currentIndex === maxIndex; // æœ€å¾Œã®æœˆã‚ˆã‚Šå…ˆã«ã‚‚é€²ã‚ãªã„

        // ã‚»ãƒ¬ã‚¯ãƒˆã®è¡¨ç¤ºã‚‚åŒæœŸ
        selectEl.value = String(currentIndex);
      };

      prevBtn.addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          updateView();
        }
      });

      nextBtn.addEventListener("click", () => {
        if (currentIndex < maxIndex) {
          currentIndex++;
          updateView();
        }
      });

      // ğŸ”¹ æœˆã‚¸ãƒ£ãƒ³ãƒ—ï¼šã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã§ä¸€æ°—ã«ãã®æœˆã¸
      selectEl.addEventListener("change", (e) => {
        const targetIndex = Number(e.target.value);
        if (!Number.isNaN(targetIndex)) {
          currentIndex = targetIndex;
          updateView();
        }
      });

      updateView();
    });
  </script>
</BaseLayout>

<style>
#schedule__pages {
  width: 100%;
  margin: 8rem 0;
}
.price-page__txt {
  margin-bottom: 5.6rem;
}
.schedule__inner {
  width: 100%;
  max-width: 80rem;
  margin: 0 auto;
}
.day-cell.is-past {
  background: #eeeeee;
  color: #999999;
}
.day-cell.is-past .status {
  opacity: 0.5;
}
.reservation-nav {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 1.6rem;
}
.nav-btn {
  height: 4rem;
  border-radius: 4px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-size: 1.6rem;
}
.nav-btn:disabled {
  opacity: 0.4;
  cursor: default;
}
.nav-btn--prev {
  position: relative;
  padding: 0 .8rem 0 3.2rem;
}
.nav-btn--prev::before,
.nav-btn--prev::after  {
  content: '';
  position: absolute;
  display: inline-block;
  border-radius: 2px;
  left: 1.2rem;
	width: .8rem;
	height: 2px;
  background-color: #333333;
}
.nav-btn--prev::before {
  top: calc(50% - 3px);
  transform: rotate(-45deg);
}
.nav-btn--prev::after {
  bottom: calc(50% - 3px);
  transform: rotate(45deg);
}
.nav-btn--next {
  position: relative;
  padding: 0 3.2rem 0 .8rem;
}
.nav-btn--next::before,
.nav-btn--next::after  {
  content: '';
  position: absolute;
  display: inline-block;
  border-radius: 2px;
  right: 1.2rem;
	width: .8rem;
	height: 2px;
  background-color: #333333;
}
.nav-btn--next::before {
  top: calc(50% - 3px);
  transform: rotate(45deg);
}
.nav-btn--next::after {
  bottom: calc(50% - 3px);
  transform: rotate(-45deg);
}
.month-picker {
  position: relative;
  display: flex;
  flex-flow: column;
  align-items: center;
  gap: 8px;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}
.month-picker__label {
  font-size: 1.4rem;
}
.month-picker__select {
  height: 4rem;
  padding: 0 2.4rem;
  border-radius: 4px;
  border: 1px solid #aaa;
  background: #fff;
  font-size: 1.6rem;
  cursor: pointer;
}
.month-picker::before,
.month-picker::after {
  content: '';
  position: absolute;
  bottom: 1.8rem;
  width: 0.8rem;
  height: 2px;
  background: #333;
  border-radius: 2px;
  pointer-events: none;
}
.month-picker::before {
  right: 1.3rem;
  transform: rotate(-45deg);
}
.month-picker::after {
  right: 1.7rem;
  transform: rotate(45deg);
}
.reservation-month {
  display: none;
  margin: 0 auto 4rem;
}
.reservation-month.is-active {
  display: block;
}
.calendar-notes {
  margin-top: 16px;
  font-size: 13px;
  line-height: 1.6;
}

@media screen and (max-width: 768px) {
  #schedule__pages {
    margin: 4rem 0;
  }
  .price-page__txt {
    margin-bottom: 2.4rem;
  }
  .reservation-nav {
    margin-bottom: .8rem;
  }
  .nav-btn {
    height: 3.2rem;
    font-size: 1.4rem;
  }
  .nav-btn--prev {
    padding: 0 .8rem 0 2.4rem;
  }
  .nav-btn--prev::before,
  .nav-btn--prev::after  {
    left: .8rem;
  }
  .nav-btn--next {
    padding: 0 2.4rem 0 .8rem;
  }
  .nav-btn--next::before,
  .nav-btn--next::after  {
    right: .8rem;
  }
  .month-picker {
    gap: 4px;
  }
  .month-picker__label {
    font-size: 1.2rem;
  }
  .month-picker__select {
    height: 3.2rem;
    padding: 0 2rem 0 .8rem;
    font-size: 1.4rem;
  }
  .month-picker::before,
  .month-picker::after {
    bottom: 1.4rem;
  }
  .month-picker::before {
  right: .8rem;
}
.month-picker::after {
  right: 1.2rem;
}
  .reservation-month {
    margin: 0 auto 1.6rem;
  }
}
</style>